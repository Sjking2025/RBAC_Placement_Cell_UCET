// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// ENUMS
// =============================================

enum UserRole {
  admin
  dept_officer
  coordinator
  student
}

enum UserStatus {
  active
  inactive
  suspended
}

enum DegreeType {
  BTech
  BE
  MTech
  MBA
  MCA
  BSc
  MSc
  BBA
  BCA
}

enum CompanyStatus {
  pending
  approved
  rejected
  active
  inactive
}

enum JobType {
  full_time
  internship
  part_time
  contract
}

enum JobStatus {
  draft
  pending
  approved
  active
  closed
  cancelled
}

enum ApplicationStatus {
  submitted
  under_review
  shortlisted
  rejected
  interview_scheduled
  selected
  offer_accepted
  offer_rejected
  withdrawn
}

enum InterviewType {
  technical
  hr
  aptitude
  group_discussion
  final
}

enum InterviewMode {
  online
  offline
  hybrid
}

enum InterviewStatus {
  scheduled
  rescheduled
  completed
  cancelled
  no_show
}

enum AnnouncementType {
  general
  urgent
  job_posting
  event
  deadline
}

enum AnnouncementPriority {
  low
  medium
  high
  critical
}

enum NotificationType {
  application_update
  interview_scheduled
  announcement
  profile_update
  job_posted
  system
}

// =============================================
// USERS & AUTHENTICATION
// =============================================

model User {
  id                 Int          @id @default(autoincrement())
  email              String       @unique @db.VarChar(255)
  password_hash      String       @db.VarChar(255)
  role               UserRole
  status             UserStatus   @default(active)
  created_at         DateTime     @default(now())
  updated_at         DateTime     @updatedAt
  last_login         DateTime?
  email_verified     Boolean      @default(false)
  verification_token String?      @db.VarChar(255)
  reset_token        String?      @db.VarChar(255)
  reset_token_expiry DateTime?

  // Relations
  user_profile       UserProfile?
  student_profile    StudentProfile?
  created_companies  Company[]      @relation("CreatedCompanies")
  approved_companies Company[]      @relation("ApprovedCompanies")
  created_jobs       JobPosting[]   @relation("CreatedJobs")
  approved_jobs      JobPosting[]   @relation("ApprovedJobs")
  reviewed_applications Application[] @relation("ReviewedApplications")
  created_interviews Interview[]
  created_announcements Announcement[]
  notifications      Notification[]
  activity_logs      ActivityLog[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Department {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  code        String   @unique @db.VarChar(50)
  description String?  @db.Text
  created_at  DateTime @default(now())

  // Relations
  user_profiles    UserProfile[]
  student_profiles StudentProfile[]
  placement_stats  PlacementStatsCache[]

  @@map("departments")
}

model UserProfile {
  id              Int       @id @default(autoincrement())
  user_id         Int       @unique
  first_name      String    @db.VarChar(100)
  last_name       String    @db.VarChar(100)
  phone           String?   @db.VarChar(20)
  department_id   Int?
  profile_picture String?   @db.VarChar(500)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  // Relations
  user       User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [department_id], references: [id])

  @@map("user_profiles")
}

// =============================================
// STUDENT PROFILES
// =============================================

model StudentProfile {
  id                  Int        @id @default(autoincrement())
  user_id             Int        @unique
  roll_number         String     @unique @db.VarChar(50)
  degree              DegreeType
  department_id       Int?
  batch_year          Int
  current_semester    Int?
  cgpa                Decimal?   @db.Decimal(4, 2)
  tenth_percentage    Decimal?   @db.Decimal(5, 2)
  twelfth_percentage  Decimal?   @db.Decimal(5, 2)
  active_backlogs     Int        @default(0)
  date_of_birth       DateTime?  @db.Date
  gender              String?    @db.VarChar(20)
  college_code        String?    @db.VarChar(50)
  college_name        String?    @db.VarChar(255)
  address             String?    @db.Text
  city                String?    @db.VarChar(100)
  state               String?    @db.VarChar(100)
  pincode             String?    @db.VarChar(10)
  resume_url          String?    @db.VarChar(500)
  linkedin_url        String?    @db.VarChar(500)
  github_url          String?    @db.VarChar(500)
  portfolio_url       String?    @db.VarChar(500)
  profile_completed   Boolean    @default(false)
  placement_status    String     @default("active") @db.VarChar(50)
  created_at          DateTime   @default(now())
  updated_at          DateTime   @updatedAt

  // Relations
  user          User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  department    Department?   @relation(fields: [department_id], references: [id])
  skills        StudentSkill[]
  projects      StudentProject[]
  certifications StudentCertification[]
  internships   StudentInternship[]
  applications  Application[]
  placement_records PlacementRecord[]

  @@index([roll_number])
  @@index([department_id])
  @@index([batch_year])
  @@map("student_profiles")
}

model StudentSkill {
  id                Int      @id @default(autoincrement())
  student_id        Int
  skill_name        String   @db.VarChar(100)
  proficiency_level String?  @db.VarChar(50)
  created_at        DateTime @default(now())

  // Relations
  student StudentProfile @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@map("student_skills")
}

model StudentProject {
  id           Int       @id @default(autoincrement())
  student_id   Int
  title        String    @db.VarChar(255)
  description  String?   @db.Text
  technologies String?   @db.Text
  start_date   DateTime? @db.Date
  end_date     DateTime? @db.Date
  project_url  String?   @db.VarChar(500)
  github_url   String?   @db.VarChar(500)
  created_at   DateTime  @default(now())

  // Relations
  student StudentProfile @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@map("student_projects")
}

model StudentCertification {
  id                   Int       @id @default(autoincrement())
  student_id           Int
  name                 String    @db.VarChar(255)
  issuing_organization String?   @db.VarChar(255)
  issue_date           DateTime? @db.Date
  expiry_date          DateTime? @db.Date
  credential_id        String?   @db.VarChar(255)
  credential_url       String?   @db.VarChar(500)
  created_at           DateTime  @default(now())

  // Relations
  student StudentProfile @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@map("student_certifications")
}

model StudentInternship {
  id           Int       @id @default(autoincrement())
  student_id   Int
  company_name String    @db.VarChar(255)
  role         String?   @db.VarChar(255)
  description  String?   @db.Text
  start_date   DateTime? @db.Date
  end_date     DateTime? @db.Date
  location     String?   @db.VarChar(255)
  created_at   DateTime  @default(now())

  // Relations
  student StudentProfile @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@map("student_internships")
}

// =============================================
// COMPANIES
// =============================================

model Company {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(255)
  website     String?       @db.VarChar(500)
  industry    String?       @db.VarChar(100)
  description String?       @db.Text
  logo_url    String?       @db.VarChar(500)
  address     String?       @db.Text
  city        String?       @db.VarChar(100)
  state       String?       @db.VarChar(100)
  country     String?       @db.VarChar(100)
  status      CompanyStatus @default(pending)
  created_by  Int?
  approved_by Int?
  approved_at DateTime?
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt

  // Relations
  creator       User?           @relation("CreatedCompanies", fields: [created_by], references: [id])
  approver      User?           @relation("ApprovedCompanies", fields: [approved_by], references: [id])
  contacts      CompanyContact[]
  job_postings  JobPosting[]
  placement_records PlacementRecord[]

  @@map("companies")
}

model CompanyContact {
  id          Int      @id @default(autoincrement())
  company_id  Int
  name        String   @db.VarChar(255)
  designation String?  @db.VarChar(255)
  email       String?  @db.VarChar(255)
  phone       String?  @db.VarChar(20)
  is_primary  Boolean  @default(false)
  created_at  DateTime @default(now())

  // Relations
  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("company_contacts")
}

// =============================================
// JOB POSTINGS
// =============================================

model JobPosting {
  id                   Int         @id @default(autoincrement())
  company_id           Int
  title                String      @db.VarChar(255)
  description          String      @db.Text
  job_type             JobType
  location             String?     @db.VarChar(255)
  work_mode            String?     @db.VarChar(50)
  salary_min           Decimal?    @db.Decimal(12, 2)
  salary_max           Decimal?    @db.Decimal(12, 2)
  currency             String      @default("INR") @db.VarChar(10)
  positions_available  Int         @default(1)
  required_cgpa        Decimal?    @db.Decimal(4, 2)
  allowed_backlogs     Int         @default(0)
  eligible_departments Int[]
  eligible_degrees     DegreeType[]
  eligible_batches     Int[]
  skills_required      String[]
  responsibilities     String?     @db.Text
  requirements         String?     @db.Text
  perks                String?     @db.Text
  application_deadline DateTime?   @db.Date
  status               JobStatus   @default(draft)
  created_by           Int?
  approved_by          Int?
  approved_at          DateTime?
  created_at           DateTime    @default(now())
  updated_at           DateTime    @updatedAt

  // Relations
  company      Company       @relation(fields: [company_id], references: [id], onDelete: Cascade)
  creator      User?         @relation("CreatedJobs", fields: [created_by], references: [id])
  approver     User?         @relation("ApprovedJobs", fields: [approved_by], references: [id])
  applications Application[]
  placement_records PlacementRecord[]

  @@index([status])
  @@index([company_id])
  @@map("job_postings")
}

// =============================================
// APPLICATIONS
// =============================================

model Application {
  id           Int               @id @default(autoincrement())
  job_id       Int
  student_id   Int
  status       ApplicationStatus @default(submitted)
  cover_letter String?           @db.Text
  resume_url   String?           @db.VarChar(500)
  applied_at   DateTime          @default(now())
  reviewed_at  DateTime?
  reviewed_by  Int?
  notes        String?           @db.Text

  // Relations
  job        JobPosting     @relation(fields: [job_id], references: [id], onDelete: Cascade)
  student    StudentProfile @relation(fields: [student_id], references: [id], onDelete: Cascade)
  reviewer   User?          @relation("ReviewedApplications", fields: [reviewed_by], references: [id])
  interviews Interview[]

  @@unique([job_id, student_id])
  @@index([student_id])
  @@index([job_id])
  @@index([status])
  @@map("applications")
}

// =============================================
// INTERVIEW SCHEDULING
// =============================================

model Interview {
  id               Int             @id @default(autoincrement())
  application_id   Int
  interview_type   InterviewType
  interview_mode   InterviewMode
  scheduled_date   DateTime        @db.Date
  scheduled_time   DateTime        @db.Time()
  duration_minutes Int             @default(60)
  location         String?         @db.VarChar(255)
  meeting_link     String?         @db.VarChar(500)
  interviewer_names String?        @db.Text
  status           InterviewStatus @default(scheduled)
  notes            String?         @db.Text
  feedback         String?         @db.Text
  result           String?         @db.VarChar(50)
  created_by       Int?
  created_at       DateTime        @default(now())
  updated_at       DateTime        @updatedAt

  // Relations
  application Application @relation(fields: [application_id], references: [id], onDelete: Cascade)
  creator     User?       @relation(fields: [created_by], references: [id])

  @@index([scheduled_date])
  @@map("interviews")
}

// =============================================
// ANNOUNCEMENTS & NOTIFICATIONS
// =============================================

model Announcement {
  id                 Int                  @id @default(autoincrement())
  title              String               @db.VarChar(255)
  content            String               @db.Text
  type               AnnouncementType     @default(general)
  priority           AnnouncementPriority @default(medium)
  target_roles       UserRole[]
  target_departments Int[]
  target_batches     Int[]
  attachment_url     String?              @db.VarChar(500)
  is_pinned          Boolean              @default(false)
  published          Boolean              @default(true)
  published_at       DateTime?
  expires_at         DateTime?
  created_by         Int?
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt

  // Relations
  creator User? @relation(fields: [created_by], references: [id])

  @@index([published])
  @@map("announcements")
}

model Notification {
  id         Int              @id @default(autoincrement())
  user_id    Int
  type       NotificationType
  title      String           @db.VarChar(255)
  message    String           @db.Text
  link       String?          @db.VarChar(500)
  read       Boolean          @default(false)
  read_at    DateTime?
  created_at DateTime         @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([read])
  @@map("notifications")
}

// =============================================
// PLACEMENT STATISTICS
// =============================================

model PlacementRecord {
  id           Int       @id @default(autoincrement())
  student_id   Int
  company_id   Int?
  job_id       Int?
  offer_date   DateTime? @db.Date
  joining_date DateTime? @db.Date
  package_lpa  Decimal?  @db.Decimal(10, 2)
  job_title    String?   @db.VarChar(255)
  job_location String?   @db.VarChar(255)
  offer_status String    @default("pending") @db.VarChar(50)
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  // Relations
  student StudentProfile @relation(fields: [student_id], references: [id], onDelete: Cascade)
  company Company?       @relation(fields: [company_id], references: [id])
  job     JobPosting?    @relation(fields: [job_id], references: [id])

  @@map("placement_records")
}

model PlacementStatsCache {
  id              Int       @id @default(autoincrement())
  academic_year   String    @db.VarChar(20)
  department_id   Int?
  total_students  Int       @default(0)
  placed_students Int       @default(0)
  average_package Decimal?  @db.Decimal(10, 2)
  highest_package Decimal?  @db.Decimal(10, 2)
  lowest_package  Decimal?  @db.Decimal(10, 2)
  total_companies Int       @default(0)
  total_offers    Int       @default(0)
  updated_at      DateTime  @updatedAt

  // Relations
  department Department? @relation(fields: [department_id], references: [id])

  @@unique([academic_year, department_id])
  @@map("placement_stats_cache")
}

// =============================================
// ACTIVITY LOGS (Audit Trail)
// =============================================

model ActivityLog {
  id          Int      @id @default(autoincrement())
  user_id     Int?
  action      String   @db.VarChar(100)
  entity_type String?  @db.VarChar(50)
  entity_id   Int?
  details     Json?
  ip_address  String?  @db.VarChar(50)
  user_agent  String?  @db.Text
  created_at  DateTime @default(now())

  // Relations
  user User? @relation(fields: [user_id], references: [id])

  @@map("activity_logs")
}
